#!/usr/bin/env php
<?php

require 'autoload.php';

$script = eZScript::instance([
    'description' => "Installer",
    'use-session' => false,
    'use-extensions' => true,
    'use-modules' => false,
    'debug-timing' => true
]);

$script->startup();
$options = $script->getOptions('[data:][languages:][cleandata:][cleanup][exlude-extension-schemas][only-data][embed_dfs_schema][dry-run]',
    '',
    array(
        'data' => "Directory of installer data",
        'cleanup' => "Cleanup db before install",
        'exlude-extension-schemas' => "Install only base without extension schema",
        'only-data' => "Install only data without base and extension schema",
        'languages' => "Comma separates language code list, first is primary (default is: eng-GB,ita-IT,ger-DE)",
        'cleandata' => "Override directory of clean db_schema.dba and db_data.dba files",
        'embed_dfs_schema' => "Install dfs schema in main db",
        'dry-run' => "Only check vars",
    )
);

$fileHandler = \eZINI::instance('file.ini')->variable('ClusteringSettings', 'FileHandler');
\eZINI::instance('file.ini')->setVariable('ClusteringSettings', 'FileHandler', 'eZFSFileHandler');
\eZINI::instance()->setVariable('ContentSettings', 'ViewCaching', 'disabled');
\eZINI::instance()->setVariable('TemplateSettings', 'TemplateCache', 'disabled');
\eZINI::instance()->setVariable('TemplateSettings', 'TemplateCompile', 'disabled');
\eZINI::instance()->setVariable('OverrideSettings', 'Cache', 'disabled');


$cli = eZCLI::instance();
$script->initialize();
$output = new ezcConsoleOutput();

/** @var eZDBInterface $db */
$db = eZDB::instance();
eZDB::setErrorHandling(eZDB::ERROR_HANDLING_EXCEPTIONS);
//eZDebug::setHandleType(eZDebug::HANDLE_EXCEPTION);

try {
    // parameters
    $cleanDb = $options['cleanup'];
    $installBaseSchema = !$options['only-data'];
    $installExtensionsSchema = !$options['exlude-extension-schemas'];
    $installDfsSchema = $options['embed_dfs_schema'];

    $cleanDataDirectory = $options['cleandata'] ? rtrim($options['cleandata']) : false;

    $languages = $options['languages'] ? $options['languages'] : 'eng-GB,ita-IT,ger-DE';
    $languageList = explode(',', $languages);

    $dataDir = $options['data'];
    if ($dataDir && !is_dir($dataDir)) {
        throw new Exception("Directory $dataDir not found");
    }

    // install
    $installer = new \Opencontent\Installer\Installer($db, $dataDir);

    if ($options['verbose']) {
        $installer->getLogger()->isVerbose = true;
    }

    if ($options['dry-run']) {
        $installer->setDryRun();
    }

    $installer->installSchema($cleanDb, $installBaseSchema, $installExtensionsSchema, $languageList, $cleanDataDirectory, $installDfsSchema);
    if ($cleanDb) {
        $installer->getLogger()->info("Cleanup solr");
        if (!$installer->isDryRun()) {
            $solr = new eZSolr();
            $solr->cleanup(true, true);
        }
    }

    \eZINI::instance('file.ini')->setVariable('ClusteringSettings', 'FileHandler', $fileHandler);

    $installer->install();

    if (!$installer->isDryRun()) {
        $cacheHelper = new eZCacheHelper($cli, $script);
        $cacheHelper->clearItems(eZCache::fetchList(), false);
    }

} catch (Throwable $e) {
    if ($db->TransactionCounter > 0) {
        $db->rollback();
    }

    $cli->error($e->getMessage());

    if ($options['debug'])
        $cli->output($e->getTraceAsString());
}

$script->shutdown();

// php bin/php/ezsqldumpschema.php --type=postgresql --user=openpa --host=db.consorzio-astratto --password= --output-array --output-types=data ez20150103_openpa_rivadelgarda openpa_tools/installer/cleandata/db_data.dba